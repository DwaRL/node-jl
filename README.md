node-jl
=====

Набор утилит для работы с файлами/потоками, содержащими JSON-записи, разделённые символом перевода строки (`\n`).
JSON-представление каждой записи не должно иметь переводов строки.

Установка
-----

```
npm install -g jl
```

Утилиты
-----

#### `jl-sort` - сортировка

Враппер над GNU Sort, позволяющий сортировать JSON. Сохраняет все плюсы обычного `sort`,
такие как поддержка сортировки в ФС, merge-sort, стабильная сортировка, ограничение размера буфера сортировки.

#### `jl-filter` - фильтрация

Аналог `grep`, но для JSON.

#### `jl-reduce` - группировка по ключу и агрегация

Обобщённая утилита, которая умеет производит свёртку элементов в одно значение для каждой группы. 
Принимает 3 аргумента обязательных в виде JS-функций: 

- `-i FUNC` - инициализатор аккумулятора: вызывается для каждой новой группы.
Функция запускается в контексте группы.
- `-u FUNC` - обновление аккумулятора: функция, вызываемая для каждого элемента группы.
Функция запускается в контексте группы и принимает аргумент `r`, в котором текущий элемент потока
- `-r FUNC` - получение значения аккумулятора: вызывается в конце группы для получения результата
Функция запускается в контексте группы.

и один необазятельный аргумент

- `-k KEYDEF` - ключ, который будет использован для группировки, может быть функций. Для правильной работы
входной поток должен быть отсортирован по этому ключу в любом направлении

Для лучшего понимания, приведу пример простой реализации `jl-sum`, которая считают сумму поля `amount`
для каждого юзера, который идентификируется полем `uid`

```
jl-reduce -k uid -i '{this.sum = 0}' -u '{this.sum += r.amount}' -r '{return this.sum}'
```

Для входного потока, содержащего
```json
{"uid": 1, "amount": 10}
{"uid": 1, "amount": 11}
{"uid": 2, "amount": 12}
{"uid": 3, "amount": 13}
```
На выходе получим
```json
{"key":1,"value":21}
{"key":2,"value":12}
{"key":3,"value":13}
```

Если не указывать `-k`, то свёртка будет проходить по всему потоку и на выходе получим одно значение
```json
{"value":46}
```

#### `jl-sum` - суммирование

Предефайн для `jl-reduce`, который считает сумму параметра по группам

#### `jl-count` - подсчёт количества

Предефайн для `jl-reduce`, который считает количество элементов в группе

#### `jl-transform` - модификация
#### `jl-extract` - извлечение значения поля
#### `jl-from-csv` - конвертация CSV в JSON
#### `jl-plainify` - конвертация сложного объекта в одноуровневый k-v
